name: TS-Prune - Clean Unused Exports

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - '!**/*.d.ts'

jobs:
  ts-prune:
    name: Check and Fix Unused Exports
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install

      - name: Install TS-Prune
        run: bun add -D ts-prune

      - name: Run TS-Prune and Auto-Fix
        id: ts-prune
        continue-on-error: true
        run: |
          echo "Running ts-prune analysis..."
          bun run ts-prune > ts-prune-report.txt 2>&1 || true
          
          if [ -s ts-prune-report.txt ]; then
            echo "found_issues=true" >> $GITHUB_OUTPUT
            echo "ðŸ§¹ Unused exports found, cleaning up..."
            cat ts-prune-report.txt
            
            # Parse and remove unused exports
            while IFS= read -r line; do
              if [[ $line =~ ^(.+):([0-9]+)\ -\ (.+)$ ]]; then
                file="${BASH_REMATCH[1]}"
                line_num="${BASH_REMATCH[2]}"
                export_name="${BASH_REMATCH[3]}"
                
                # Skip if file doesn't exist or is in node_modules
                if [[ ! -f "$file" ]] || [[ "$file" == *"node_modules"* ]]; then
                  continue
                fi
                
                echo "Removing unused export from $file:$line_num - $export_name"
                
                # Comment out the export line
                sed -i "${line_num}s/^/\/\/ [unused] /" "$file"
              fi
            done < ts-prune-report.txt
            
            echo "âœ… Cleaned up unused exports!"
          else
            echo "found_issues=false" >> $GITHUB_OUTPUT
            echo "âœ… No unused exports found!"
          fi

      - name: Commit Cleanup
        if: steps.ts-prune.outputs.found_issues == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: remove unused exports" -m "- Auto-removed unused exports detected by ts-prune" -m "- Exports commented out with [unused] tag" -m "- Generated by ts-prune workflow"
            
            git push
            echo "âœ… Unused exports cleaned up and committed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Success Summary
        run: |
          if [ "${{ steps.ts-prune.outputs.found_issues }}" == "true" ]; then
            echo "## ðŸ§¹ TS-Prune Results Committed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Found unused exports. Results committed to repository." >> $GITHUB_STEP_SUMMARY
            echo "Please review ts-prune-report.txt for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… TS-Prune Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No unused exports found in the codebase!" >> $GITHUB_STEP_SUMMARY
          fi
